(function(){"use strict";var u=async(r={},e)=>{let t;if(e.startsWith("data:")){const n=atob(e.replace(/^data:.*?base64,/,"")),a=new Uint8Array(n.length);for(let s=0;s<n.length;s++)a[s]=n.charCodeAt(s);t=await WebAssembly.instantiate(a,r)}else{const n=await fetch(e),a=n.headers.get("Content-Type")||"";if("instantiateStreaming"in WebAssembly&&a.startsWith("application/wasm"))t=await WebAssembly.instantiateStreaming(n,r);else{const s=await n.arrayBuffer();t=await WebAssembly.instantiate(s,r)}}return t.instance.exports},_=r=>u(r,"/niivue-niimath/assets/process-image.218eaa4f.wasm");let o=8,g=8,b=3;function y(r,e){if(!r)throw new Error(e)}function p(r){return r&&(r&r-1)==0}function v(r){y(p(r),`not power of two: ${r}`)}function A(r,e){return v(e),(r&e-1)==0}function U(r,e){y(A(r,e),`bad alignment: ${r} % ${e}`)}class C{constructor(e){this.maxwords=e/o,this.state=new Uint8Array(this.maxwords/g),this.allocations=new Map}acquire(e,t){U(e,o);for(let n=0;n<t;n+=o){let a=(e+n)/o,s=a>>b,i=1<<(a&g-1);y((this.state[s]&i)==0,"word in use"),this.state[s]|=i}this.allocations.set(e,t)}release(e){y(this.allocations.has(e));let t=this.allocations.get(e);this.allocations.delete(e);for(let n=0;n<t;n+=o){let a=(e+n)/o,s=a>>b,i=1<<(a&g-1);this.state[s]&=~i}}}class M{constructor({initial:e=2048,maximum:t=2048}){this.memory=new WebAssembly.Memory({initial:e,maximum:t}),this.verifier=new C(t*65536)}record_malloc(e,t){this.verifier.acquire(e,t)}record_free(e){this.verifier.release(e)}read_string(e){let t=new Uint8Array(this.memory.buffer),n=[];for(let a=t[e];a;a=t[++e])n.push(a);return String.fromCharCode(...n)}log(e){console.log(`wasm log: ${e}`)}log_i(e,t){console.log(`wasm log: ${e}: ${t}`)}env(){return{memory:this.memory,wasm_log:e=>this.log(this.read_string(e)),wasm_log_i:(e,t)=>this.log_i(this.read_string(e),t)}}}let c=new M({initial:256,maximum:2048}),$=_({env:c.env()});addEventListener("message",r=>{$.then(e=>{const t=r.data[0],n=r.data[1],a=r.data[2],s=r.data[3];let i=e.walloc(a.length+1);c.record_malloc(i,a.length+1);let h=new Uint8Array(a.length+1);for(let d=0;d<a.length;d++)h[d]=a.charCodeAt(d);new Uint8Array(e.memory.buffer,i,a.length+1).set(h);let w=t.nx*t.ny*t.nz*t.nt,l=e.walloc(w*t.bpv);c.record_malloc(l,w*t.bpv);let m=new Uint8Array(e.memory.buffer,l,w*t.bpv);m.set(new Uint8Array(n));let f=e.niimath(l,t.datatypeCode,t.nx,t.ny,t.nz,t.nt,t.dx,t.dy,t.dz,t.dt,i);if(f!=0){console.error(" -> '",a," generated a fatal error: ",f);return}m=new Uint8Array(e.memory.buffer,l,w*t.bpv);let z=new Uint8Array(m,0,w*t.bpv);postMessage({id:t.id,imageBytes:z,cmd:a,isNewLayer:s}),c.record_free(i),e.wfree(i),c.record_free(l),e.wfree(l)})})})();
